# 🛡️ Windows C++ 软件授权监控服务 (MonitorService)

本项目是一个在 Windows 平台下运行的 C++ 控制台应用程序，旨在实现对目标软件的试用期管理、防止系统时间篡改，并通过硬件 ID (HWID) 绑定实现安全的密钥授权机制。

## 🚀 项目概览

### 核心功能

- **注册表存储：** 在 Windows 注册表 (`HKEY_CURRENT_USER\SOFTWARE\MyCompany\MonitorService`) 中安全存储配置信息和授权状态。
- **日期防篡改：** 实时监控系统日期，防止用户通过将时间回拨来延长试用期。
- **进程监控与冻结：** 持续检测目标软件是否运行。一旦到期或检测到篡改，立即冻结目标窗口并弹出提示。
- **硬件 ID (HWID) 绑定：** 通过获取 MAC 地址和 BIOS 序列号生成唯一的机器指纹，实现密钥的单机绑定。
- **一次性/永久密钥：** 支持使用密钥延长试用期或永久解除监控。

### 技术栈

- **语言：** C++ (C++17/WinAPI)
- **平台：** Windows
- **关键 API/库：** Windows Registry API, `Iphlpapi.lib`, `TlHelp32.h` (进程枚举), `Windows.h` (窗口控制)

## ⚙️ 构建与环境要求

本项目推荐使用 **Visual Studio 2019 或更高版本**进行构建。

### 环境依赖

1.  **C++ 桌面开发工作负载** (Visual Studio)
2.  **链接器依赖:** 必须确保链接以下库文件：
    - `iphlpapi.lib` (用于获取 MAC 地址)
    - `advapi32.lib` (用于注册表操作)

### Visual Studio 配置 (推荐)

1.  将所有 `.cpp` 和 `.h` 文件添加到项目中。
2.  在 **项目属性** -> **链接器** -> **输入** -> **附加依赖项** 中，添加或确认存在以下项：
    ```
    iphlhapi.lib;advapi32.lib;%(AdditionalDependencies)
    ```

## 📂 项目结构

MonitorService/ ├── main.cpp # 主入口，提供命令行交互和配置菜单 ├── RegistryManager.h # 注册表读写声明 ├── RegistryManager.cpp # 注册表读写实现 ├── MonitorCore.h # 监控核心类声明 (日期检查, 密钥验证) ├── MonitorCore.cpp # 监控核心实现 (进程监控, 窗口冻结, 密钥逻辑) ├── HardwareID.h # 硬件 ID 获取和哈希声明 ├── HardwareID.cpp # 硬件 ID 和简化版 SHA-256 实现 (生产环境需替换为专业加密库!) └── Utils.h # 辅助函数 (日期格式化)

## 📝 使用说明

### 1. 首次配置与运行

1.  构建项目，生成 `MonitorService.exe`。
2.  运行程序，您将看到控制台菜单：
    ```
    --- 软件监控服务控制台 ---
    1. 配置并启动监控
    2. 激活密钥
    3. 运行监控核心 (假设服务已配置)
    4. 退出
    --------------------------------
    ```
3.  选择 `1. 配置并启动监控`：
    - 输入要监控的目标软件名称 (例如: `TargetApp.exe`)。
    - 输入试用截止日期 (格式: `YYYYMMDD`，例如 `20261231`)。

### 2. 获取本机 HWID (用于客服生成密钥)

1.  选择 `3. 运行监控核心`。
2.  程序启动后，会立即计算并打印本机的硬件 ID (HWID)：
    ```
    [HWID] 本机硬件ID (请提供给客服):
    0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF
    --------------------------------------
    [CORE] ✅ 状态正常，持续监控中...
    ```
3.  **将这串 HWID 提供给您的客服或后台系统，用于生成唯一绑定的密钥。**

### 3. 密钥激活

1.  收到客服生成的密钥后，选择 `2. 激活密钥`。
2.  输入完整的密钥。
3.  系统将自动验证 HWID、过期日期和密钥类型 (TEMP/FINAL) 并更新注册表。

---

## 🔑 密钥格式与验证 (后台说明)

密钥格式基于 HWID 绑定和时间戳，结构为：

[HWID 哈希前缀][新的截止日期 YYYYMMDD][魔术代码]

| 组成部分       | 描述                                                                          |
| :------------- | :---------------------------------------------------------------------------- |
| `HWID哈希前缀` | 本机 HWID 的 SHA-256 哈希值的一部分，用于单机绑定。                           |
| `新的截止日期` | 激活后软件将运行至该日期。永久密钥通常使用一个遥远的日期 (e.g., `20991231`)。 |
| `魔术代码`     | `FINAL` (永久激活) 或 `TEMP` (临时激活)。                                     |

**密钥生成示例：**

| 目的         | 示例密钥 (假设 HWID 匹配)  | 结果                                                     |
| :----------- | :------------------------- | :------------------------------------------------------- |
| **永久授权** | `A1B2C3..._20991231_FINAL` | KeyStatus 设置为 PermanentActive (2)，监控停止。         |
| **临时延期** | `A1B2C3..._20261130_TEMP`  | ExpiryDate 更新，KeyStatus 设置为 OneTimeKeyActive (1)。 |

## ⚠️ 重要说明

1.  **安全性：** `HardwareID.cpp` 中提供的 **SHA-256 函数是简化版**。在生产环境中，**必须**使用如 OpenSSL、Crypto++ 或 Windows CNG (Cryptography API: Next Generation) 等专业的、经过安全审计的加密库来实现真正的哈希和密钥签名功能。
2.  **生产环境：** 本控制台应用仅用于开发和演示。在实际部署中，您需要将核心监控逻辑重构为一个 **Windows Service**，使其可以在后台持续运行，并以高权限运行。
3.  **错误处理：** 生产代码应包含更健壮的错误处理和日志记录，尤其是注册表操作和进程枚举部分。

# 🛡️ Windows C++ 软件授权监控服务 (MonitorService)

本项目是一个在 Windows 平台下运行的 C++ 控制台应用程序，旨在实现对目标软件的试用期管理、防止系统时间篡改，并通过硬件 ID (HWID) 绑定实现安全的密钥授权机制。

## 🚀 项目概览

### 核心功能

- **注册表存储：** 在 Windows 注册表 (`HKEY_CURRENT_USER\SOFTWARE\MyCompany\MonitorService`) 中安全存储配置信息和授权状态。
- **日期防篡改：** 实时监控系统日期，防止用户通过将时间回拨来延长试用期。
- **进程监控与冻结：** 持续检测目标软件是否运行。一旦到期或检测到篡改，立即冻结目标窗口并弹出提示。
- **硬件 ID (HWID) 绑定：** 通过获取 MAC 地址和 BIOS 序列号生成唯一的机器指纹，实现密钥的单机绑定。
- **一次性/永久密钥：** 支持使用密钥延长试用期或永久解除监控。

### 技术栈

- **语言：** C++ (C++17/WinAPI)
- **平台：** Windows
- **关键 API/库：** Windows Registry API, `Iphlpapi.lib`, `TlHelp32.h` (进程枚举), `Windows.h` (窗口控制)

## ⚙️ 构建与环境要求

本项目推荐使用 **Visual Studio 2019 或更高版本**进行构建。

### 环境依赖

1.  **C++ 桌面开发工作负载** (Visual Studio)
2.  **链接器依赖:** 必须确保链接以下库文件：
    - `iphlpapi.lib` (用于获取 MAC 地址)
    - `advapi32.lib` (用于注册表操作)

---

## 🏗️ 配置共享动态库和密钥工具

为了实现代码共享，本项目采用了 **动态链接库 (DLL)** 结构，将 HWID 和哈希核心逻辑分离。

### 1. 创建 SharedAuthDLL (动态链接库)

此项目用于封装 `HardwareID.cpp` 和 `Utils.cpp` 中的所有共享逻辑。

| 步骤                  | 操作说明                                                                                         | 配置要点                                                     |
| :-------------------- | :----------------------------------------------------------------------------------------------- | :----------------------------------------------------------- |
| **A. 创建项目**       | 在解决方案中 **添加** -> **新建项目**，选择 **动态链接库 (DLL)** 模板，命名为 `SharedAuthDLL`。  | 平台选择 **x64** 和 **Win32**。                              |
| **B. 移动和添加文件** | 将 `HardwareID.h/cpp` 和 `Utils.h/cpp` 文件**移动**到 `SharedAuthDLL` 文件夹，并添加到该项目中。 | -                                                            |
| **C. 定义导出宏**     | 新建 `SharedAuthDLL.h` 文件，定义 `SHAREDAUTHDLL_API` 宏。                                       | -                                                            |
| **D. 标记导出函数**   | 在 `HardwareID.h` 和 `Utils.h` 中，在所有需要外部调用的函数前加上 `SHAREDAUTHDLL_API`。          | 例如：`SHAREDAUTHDLL_API std::wstring GenerateHardwareId();` |
| **E. 配置导出**       | `SharedAuthDLL` 项目属性 -> C/C++ -> 预处理器 -> 预处理器定义中添加：`SHAREDAUTHDLL_EXPORTS`     | 确保配置 **Debug/Release** 和 **x64/Win32** 都设置。         |
| **F. 链接系统库**     | `SharedAuthDLL` 项目属性 -> 链接器 -> 输入 -> 附加依赖项中添加：`iphlpapi.lib;advapi32.lib;`     | 必须链接这两个库，否则 HWID 采集将失败。                     |

### 2. 创建 KeyGenTool (密钥生成工具)

此项目是您（客服）在本地使用的命令行工具。

| 步骤                | 操作说明                                                                                                   | 配置要点                                                          |
| :------------------ | :--------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------- |
| **A. 创建项目**     | 在解决方案中 **添加** -> **新建项目**，选择 **控制台应用 (Console App)**，命名为 `KeyGenTool`。            | 确保平台（x64/Win32）与 DLL 保持一致。                            |
| **B. 添加主文件**   | 添加 `KeyGenerator.cpp` 文件，包含密钥生成逻辑。                                                           | -                                                                 |
| **C. 设置项目引用** | 右键点击 `KeyGenTool` -> **添加** -> **引用**，勾选 `SharedAuthDLL`。                                      | 此步骤自动处理 `.lib` 文件链接。                                  |
| **D. 设置包含目录** | `KeyGenTool` 项目属性 -> C/C++ -> 常规 -> 附加包含目录中添加：`$(SolutionDir)SharedAuthDLL`                | 确保能找到 `HardwareID.h` 等头文件。                              |
| **E. 附加库目录**   | `KeyGenTool` 项目属性 -> 链接器 -> 常规 -> 附加库目录中添加：`$(SolutionDir)$(Platform)\$(Configuration)\` | **用于解决 LNK1104 错误**，确保链接器能找到 `SharedAuthDLL.lib`。 |

### 3. 配置 MonitorService (客户端服务)

原有的 `MonitorService` 项目也需要修改，以便调用 DLL 中的函数。

| 步骤                | 操作说明                                                                                                       | 配置要点                    |
| :------------------ | :------------------------------------------------------------------------------------------------------------- | :-------------------------- |
| **A. 设置项目引用** | 右键点击 `MonitorService` -> **添加** -> **引用**，勾选 `SharedAuthDLL`。                                      | -                           |
| **B. 设置包含目录** | `MonitorService` 项目属性 -> C/C++ -> 常规 -> 附加包含目录中添加：`$(SolutionDir)SharedAuthDLL`                | -                           |
| **C. 附加库目录**   | `MonitorService` 项目属性 -> 链接器 -> 常规 -> 附加库目录中添加：`$(SolutionDir)$(Platform)\$(Configuration)\` | **用于解决 LNK1104 错误**。 |
| **D. 包含头文件**   | 在 `MonitorCore.cpp` 和其他需要使用共享函数的源文件中，包含 `HardwareID.h` 和 `Utils.h`。                      | -                           |

---

## 📝 使用说明

... _(此处接续原 README 中的使用说明章节)_ ...
